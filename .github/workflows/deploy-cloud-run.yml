name: Build And Deploy Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  REGION: us-west1
  SERVICE_NAME: notify-gateway
  GAR_REPO: notify-gateway
  IMAGE_NAME: notify-gateway

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required GitHub vars/secrets
        env:
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        run: |
          set -euo pipefail
          [ -n "${GCP_PROJECT_ID}" ] || { echo "::error::Missing repository variable GCP_PROJECT_ID"; exit 1; }
          [ -n "${GCP_WORKLOAD_IDENTITY_PROVIDER}" ] || { echo "::error::Missing repository secret GCP_WORKLOAD_IDENTITY_PROVIDER"; exit 1; }
          [ -n "${GCP_SERVICE_ACCOUNT_EMAIL}" ] || { echo "::error::Missing repository secret GCP_SERVICE_ACCOUNT_EMAIL"; exit 1; }

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${{ env.REGION }}-docker.pkg.dev" --quiet

      - name: Build and push image
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${GITHUB_SHA}"
          IMAGE_LATEST="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest"

          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"

          docker tag "${IMAGE_URI}" "${IMAGE_LATEST}"
          docker push "${IMAGE_LATEST}"

          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"

      - name: Deploy to Cloud Run (image)
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          gcloud run deploy "${SERVICE_NAME}" \
            --project "${PROJECT_ID}" \
            --image "${IMAGE_URI}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 1 \
            --cpu 1 \
            --memory 512Mi \
            --concurrency 20 \
            --timeout 30

      - name: Update route config env vars
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          gcloud run services update "${SERVICE_NAME}" \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --update-env-vars "^@^ENABLED_CHANNELS=tg,wecom,serverchan@ROUTE_CRITICAL=tg,wecom@ROUTE_WARNING=tg,wecom@ROUTE_INFO=tg,wecom@DEDUPE_WINDOW_MS=45000"
